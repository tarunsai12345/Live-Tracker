<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }

    .search-box {
      position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
      background: white; padding: 12px 15px; border-radius: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;
      display: flex; align-items: center; gap: 10px;
    }
    .search-box input {
      padding: 10px 15px; border: none; outline: none;
      border-radius: 20px; background: #f0f0f0;
      font-size: 14px; width: 220px; transition: 0.3s;
    }
    .search-box input:focus {
      background: #fff; box-shadow: 0 0 6px rgba(0,150,255,0.4);
    }
    .search-box button {
      padding: 10px 18px; border: none; border-radius: 20px;
      background: #0078ff; color: white; font-weight: bold;
      cursor: pointer; transition: 0.3s;
    }
    .search-box button:hover { background: #005fcc; }
  </style>
</head>
<body>
  <div class="search-box">
    <input type="text" id="locationInput" placeholder="üîç Search location">
    <button onclick="searchLocation()">Search</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const API_KEY = "72e610552000057fb277578ec925f0e8"; // OpenWeather API
    const map = L.map("map").setView([0, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors"
    }).addTo(map);

    let liveMarker, searchMarker, routeLine, liveCoords;

    const greenIcon = new L.Icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
      shadowUrl: "https://unpkg.com/leaflet/dist/images/marker-shadow.png",
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    async function getWeather(lat, lon) {
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`;
      const res = await fetch(url);
      const data = await res.json();
      return `${data.weather[0].description}, üå°Ô∏è ${data.main.temp}¬∞C, üíß Humidity: ${data.main.humidity}%`;
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return (R * c).toFixed(2);
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;
        liveCoords = [latitude, longitude];
        map.setView(liveCoords, 13);

        const weather = await getWeather(latitude, longitude);

        liveMarker = L.marker(liveCoords, { icon: greenIcon })
          .addTo(map)
          .bindPopup(`<b>üìç Your Location</b><br>${weather}`);

        liveMarker.bindTooltip("üìç Your Location", { permanent: false, direction: "top" });
      });
    }

    async function searchLocation() {
      const location = document.getElementById("locationInput").value;
      if (!location) return;

      const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${location}`;
      const res = await fetch(geoUrl);
      const data = await res.json();
      if (data.length === 0) {
        alert("Location not found");
        return;
      }

      const lat = parseFloat(data[0].lat), lon = parseFloat(data[0].lon);
      map.setView([lat, lon], 13);

      const weather = await getWeather(lat, lon);

      if (searchMarker) map.removeLayer(searchMarker);
      if (routeLine) map.removeLayer(routeLine);

      let popupText = `<b>üìç ${location}</b><br>${weather}`;

      if (liveCoords) {
        const dist = getDistance(liveCoords[0], liveCoords[1], lat, lon);
        popupText += `<br>üìè Distance from you: <b>${dist} km</b>`;

        // Add line with distance tooltip
        routeLine = L.polyline([liveCoords, [lat, lon]], { color: "blue" })
          .addTo(map)
          .bindTooltip(`üìè ${dist} km away`, { permanent: false, direction: "center" });
      }

      searchMarker = L.marker([lat, lon]).addTo(map)
        .bindPopup(popupText)
        .openPopup();

      // Hover tooltip with highlighted location name
      searchMarker.bindTooltip(`üìç ${location}`, { permanent: false, direction: "top" });
    }
  </script>
</body>
</html>
